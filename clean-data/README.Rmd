---
title: "ICCS"
author: "Jenny"
date: "January, 2019"
output: 
  github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10)

library(tidyverse)
library(readr)
library(purrr)
library(writexl)
```


## Introduction

This file documents the data cleaning for the ICCS 1999-2009-2016 Citizenship Norms Project

Note that for citizenship norm recodes in all three survey waves, the norms are coded in the descending mean order of the 1999 data: obey,rights,local,work,envir,vote,history,respect,news,protest,discuss,party


## 1999 data loading and merging

1999 data: https://www.icpsr.umich.edu/icpsrweb/civicleads/studies/21661/datadocumentation  
Downloaded Jan 17, 2019

Load 1999 country files, in chronological order of file names. Bind all 1999 files. Note, total observations of resulting tbl1 (93,882) concur with xls documentation of expected total n

```{r}

# all files
files <- list.files("../data", full.names = TRUE)

# helper function to load files
load_files <- function(file) {
  e <- new.env()
  load(file, envir = e)
  
  stopifnot(length(e) == 1)  # safety first
  
  get(names(e)[1], envir = e)
}

tbl1 <- files %>%
  magrittr::extract(1:28) %>%      # filter to 1999 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
               BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3,TOTWGT)) %>% 
  reduce(rbind) %>% 
  as_tibble() %>% 
  mutate(`ICCS_year` = 1999) %>%     # add survey year variable
  select(`ICCS_year`, everything())
```

Cit norm, count all indicators to begin recode.

```{r}

original_vars <- tbl1 %>% 
  select(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3) %>% 
  colnames() 

original_vars %>% 
  map(~ tbl1 %>% count(!!sym(.x)))
```


Cit norm, count and recode 1st indicator as example.

```{r}

# recode
tbl1 <- tbl1 %>% 
  mutate(BS3B1_binary = fct_collapse(BS3B1, 
  "not important" = c("(1) not important", "(2) somewhat unimportant"),
  "important"     = c("(3) somewhat important", "(4) very important")))

# confirm correct recode
tbl1 %>%
  count(BS3B1, BS3B1_binary) 
```


Repeat for all all cit norm indicators. NOTE: BS3B12 recoded separately below b/c of typo in string variable.
```{r}

tbl1 <-tbl1 %>% 
  mutate_at(vars(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B3),
            funs(bin = fct_collapse(.,
                                    "not important"= c("(1) not important", "(2) somewhat unimportant"),
                                    "important"    = c("(3) somewhat important", "(4) very important")))
  )
```

BS3B12 error troubleshoot when included in prior chunk. Count table command below yields console output showing that string text of 1st category "importnat"  spelled incorrectly, i.e. "a" and "n" transposed.  BS3B12 "mutate" command to correctly recode with this typo:

```{r}

# troubleshoot
tbl1 %>% count(BS3B12) 

# recode
tbl1 <- tbl1 %>% 
  mutate(BS3B12_bin = fct_collapse(BS3B12, 
                                   "not important" = c("(1) not importnat", "(2) somewhat unimportant"),
                                   "important"     = c("(3) somewhat important", "(4) very important"))
  )
```

Confirm successful mutates for all indicators.

```{r}

bin_vars <- original_vars %>% 
  paste0("_bin")

map2(original_vars, bin_vars, ~ tbl1 %>% count(!!sym(.x), !!sym(.y)))
```

Select for LCA vars tibble, including rename all 12 mutated variables and display first five lines of dataframe.  Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl1 <- tbl1 %>%
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         TOTWGT,
         obey    = BS3B1_bin,
         rights  = BS3B11_bin,
         local   = BS3B9_bin,
         work    = BS3B4_bin,
         envir   = BS3B13_bin,
         vote    = BS3B2_bin,
         history = BS3B6_bin,
         respect = BS3B10_bin,
         news    = BS3B8_bin,
         protest = BS3B5_bin,
         discuss = BS3B12_bin,
         party   = BS3B3_bin)

tbl1 %>% head()
```


## 2009 dataloading and merging

2009 data: https://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/36997 
Downloaded Jan 17, 2019

Load 2009 country files, in chronological order of file names. Bind all 2009 files; Note, total observations of resulting tbl2 (140,650) concur with xls documentation of expected total n.

```{r}

tbl2 <- files %>%
  magrittr::extract(29:66) %>%      # filter to 2009 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A,
               IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B,TOTWGTS)) %>% 
  reduce(rbind) %>% 
  as_tibble() %>% 
  mutate(`ICCS_year` = 2009) %>%     # survey year variable creation
  select(`ICCS_year`, everything())
```

Cit norm, count all indicators to begin recode.

```{r}

original_vars <- tbl2 %>% 
  select(IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A, IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B) %>% 
  colnames() 

original_vars %>% 
  map(~ tbl2 %>% count(!!sym(.x)))
```

Recode all cit norm indicators. 

```{r}

tbl2 <- tbl2 %>% 
  mutate_at(vars(IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A, IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B),
            funs(bin = fct_collapse(.,
                                    "not important" = c("(3) NOT VERY IMPORTANT", "(4) NOT IMPORTANT AT ALL"),
                                    "important"     = c("(1) VERY IMPORTANT", "(2) QUITE IMPORTANT")))
  )
```

Confirm successful recodes.

```{r}

bin_vars <- original_vars %>% 
  paste0("_bin")

map2(original_vars, bin_vars, ~ tbl2 %>% count(!!sym(.x), !!sym(.y)))
```

Select to rename all 12 mutated variables and display first five lines of dataframe - listed in order of 1999 descending means (IJCS article).  Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl2 <- tbl2 %>%
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         TOTWGTS,
         obey    = IS2P21L_bin,
         rights  = IS2P21I_bin,
         local   = IS2P21H_bin,
         work    = IS2P21K_bin,
         envir   = IS2P21J_bin,
         vote    = IS2P21A_bin,
         history = IS2P21C_bin,
         respect = IS2P21E_bin,
         news    = IS2P21D_bin,
         protest = IS2P21G_bin,
         discuss = IS2P21F_bin,
         party   = IS2P21B_bin) 

tbl2 %>% head()
```


## 2016 data loading and merging

2016 data: https://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/37147 
Downloaded Jan 21, 2019

2016 country files, in chronological order of file names. Bind all 2016 country files. Note, total observations of resulting tbl (94,603) concur with xls documentation of expected total n.

```{r}

tbl3 <- files %>%
  magrittr::extract(67:90) %>%      # filter to 2016 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J,
               IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B,TOTWGTS)) %>% 
  reduce(rbind) %>% 
  as_tibble()%>% 
  mutate(`ICCS_year` = 2016) %>%    # create survey year variable
  select(`ICCS_year`, everything())
```

Cit norm, count all indicators to begin recode.

```{r}

original_vars <- tbl3 %>% 
  select(IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J, IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B) %>% 
  colnames() 

original_vars %>% 
  map(~ tbl3 %>% count(!!sym(.x)))
```


Recode all cit norm indicators. 

```{r}

tbl3 <- tbl3 %>% 
  mutate_at(vars(IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J, IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B),
            funs(bin = fct_collapse(.,
                                    "not important" = c("(3) Not very important", "(4) Not important at all"),
                                    "important"     = c("(1) Very important", "(2) Quite important")))
  )
```

Confirm successful mutates.

```{r}

bin_vars <- original_vars %>% 
  paste0("_bin")

map2(original_vars, bin_vars, ~ tbl3 %>% count(!!sym(.x), !!sym(.y)))
```

Select to rename all 12 mutated variables and display first five lines of dataframe - listed in order of 1999 descending means (IJCS article). Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl3 <- tbl3 %>% 
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         TOTWGTS,
         obey    = IS3G23L_bin,
         rights  = IS3G23I_bin,
         local   = IS3G23H_bin,
         work    = IS3G23K_bin,
         envir   = IS3G23J_bin,
         vote    = IS3G23A_bin,
         history = IS3G23C_bin,
         respect = IS3G23E_bin,
         news    = IS3G23D_bin,
         protest = IS3G23G_bin,
         discuss = IS3G23F_bin,
         party   = IS3G23B_bin)

tbl3 %>% head()
```


## Combining recoded 1999, 2009 and 2016 data frames 

Combine the three data frames and create unique id per observation across binded country files to be able to import Latent Gold class assignment for each unique observation.

```{r}

tbl <- rbind(tbl1, tbl2, tbl3) %>% 
  mutate(id  = row_number(),
         id2 = paste0(COUNTRY, IDSTUD))
```

Check number of observations by survey year of the combined data frame.
```{r}

# number of observations by survey year
tbl %>% 
  count(ICCS_year) %>% 
  knitr::kable()
```


## Exporting final combined datafile

Before exporting, convert citizenship norm indicators to integer (0 = "not important", 1 = "important").

```{r}

cit_norm_indicators <- vars(obey, rights, local, work, envir, vote, history, respect, news, protest, discuss, party)

tbl <- tbl %>% 
  mutate_at(cit_norm_indicators,
            funs(case_when(
              . == "not important" ~ 0,
              . == "important"     ~ 1
            ))
  ) %>% 
  mutate_if(is.double, as.integer) %>% 
  mutate(COUNTRY = as.character(COUNTRY))

tbl %>% head()
```

We can also attach factor labels to the citizenship norm indicators for internal use in R, but won't export the factor labels to the output text file (we'd have to save as an R object .e.g `.rds`).  An example of how we can do this:

```{r}

example <- tbl %>% 
  mutate_at(cit_norm_indicators,
            funs(haven::labelled(., labels = c("not important" = 0, "important" = 1))))

# cit norm indicator vars are now int+lbl type
example %>% 
  glimpse()

# access labels by converting those vars to factors
example %>% 
  mutate_at(cit_norm_indicators, funs(as_factor(.)))
```

Export recoded data for LCA - RdM to current `ICCS-2019/clean-data` directory.

```{r}

write_delim(tbl, "output/clean_tbl.dat", na = ".")
```

## Tables:

Means of citizenship norm indicators by country and year.

```{r}

# count and percent of responses to "obey" grouped by year
means <- tbl %>%
  group_by(COUNTRY, ICCS_year) %>% 
  summarize_at(cit_norm_indicators, funs(mean(., na.rm = TRUE)))

means %>% 
  knitr::kable()
```

Count and percentage of missing values for each indicator by country and year.

```{r}

missing <- tbl %>% 
  group_by(COUNTRY, ICCS_year) %>% 
  summarize_at(cit_norm_indicators,
               funs(paste0(sum(is.na(.)), " (", (round(sum(is.na(.)) / length(.) * 100, 2)), "%)")))

missing %>% 
  knitr::kable()
```

Write tables to excel.

```{r}

write_xlsx(list(means = means, missing = missing), "output/citizenship-norm-indicator-tables.xlsx")
```


## Figures:

Means for twelve citizenship norm indicators for only the 14 countries that are included in all three waves of the survey.

```{r plots}

all_wave_countries <- tbl %>%
  count(COUNTRY, ICCS_year) %>% 
  count(COUNTRY) %>%
  filter(nn == 3) %>% 
  pull(COUNTRY)

plot_tbl <- tbl %>% 
  filter(COUNTRY %in% all_wave_countries) %>% 
  group_by(ICCS_year) %>% 
  summarize_at(cit_norm_indicators, funs(mean(., na.rm = TRUE)))

plot_tbl %>% 
  knitr::kable()

# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>% 
  gather(Indicator, value, -ICCS_year) %>% 
  ggplot(aes(x = ICCS_year, y = value, group = Indicator, colour = Indicator)) +
  geom_line() +
  geom_point() +
  labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year")

ggsave("output/mean-citizenship-norm-line-plot-by-year.png")

# bar plot with indicators on x-axis, lines colored by year
plot_tbl %>% 
  gather(Indicator, value, -ICCS_year) %>% 
  mutate(Year = as.factor(ICCS_year),
         Indicator = factor(Indicator, ordered = TRUE, levels = c("obey", "rights", "local", "work", "envir", "vote", "history",
                                                                  "respect", "news", "protest", "discuss", "party"))) %>% 
  ggplot(aes(x = Indicator, y = value, fill = Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "Indicator", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year")

ggsave("output/mean-citizenship-norm-bar-plot-by-indicator.png")

```
