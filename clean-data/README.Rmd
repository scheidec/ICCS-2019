---
title: "ICCS"
author: "Jenny"
date: "January, 2019"
output: 
  github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(purrr)
```

## Introduction

This file documents the data cleaning for the ICCS 1999-2009-2016 Citizenship Norms Project

Note that for citizenship norm recodes in all three survey waves, the norms are coded in the descending mean order of the 1999 data: obey,rights,local,work,envir,vote,history,respect,news,protest,discuss,party


## 1999 data loading and merging

1999 data: https://www.icpsr.umich.edu/icpsrweb/civicleads/studies/21661/datadocumentation  
Downloaded Jan 17, 2019

Load 1999 country files, in chronological order of file names. Bind all 1999 files. Note, total observations of resulting tbl1 (93,882) concur with xls documentation of expected total n

```{r}

# all files
files <- list.files("../data", full.names = TRUE)

# helper function to load files
load_files <- function(file) {
  e <- new.env()
  load(file, envir = e)
  
  stopifnot(length(e) == 1)  # safety first
  
  get(names(e)[1], envir = e)
}

tbl1 <- files %>%
  magrittr::extract(1:28) %>%      # filter to 1999 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
               BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3)) %>% 
  reduce(rbind) %>% 
  as_tibble() %>% 
  mutate(`ICCS_year` = 1999) %>%     # add survey year variable
  select(`ICCS_year`, everything())
```

Cit norm, count and recode 1st indicator as example .

```{r}

# count
tbl1 %>% count(BS3B1) 

# recode
tbl1 <- tbl1 %>% 
  mutate(BS3B1_binary = fct_collapse(BS3B1, 
  "not important" = c("(1) not important", "(2) somewhat unimportant"),
  "important"     = c("(3) somewhat important", "(4) very important")))

# confirm correct recode
tbl1 %>%
  count(BS3B1, BS3B1_binary) 
```


Repeat for all all cit norm indicators. NOTE: BS3B12 recoded separately below b/c of typo in string variable.
```{r}

tbl1 <-tbl1 %>% 
  mutate_at(vars(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B3),
            funs(bin = fct_collapse(.,
                                    "not important"= c("(1) not important", "(2) somewhat unimportant"),
                                    "important"    = c("(3) somewhat important", "(4) very important")))
  )
```

BS3B12 error troubleshoot when included in prior chunk. Count table command below yields console output showing that string text of 1st category "importnat"  spelled incorrectly, i.e. "a" and "n" transposed.  BS3B12 "mutate" command to correctly recode with this typo:

```{r}

# troubleshoot
tbl1 %>% count(BS3B12) 

# recode
tbl1 <- tbl1 %>% 
  mutate (BS3B12_bin = fct_collapse(BS3B12, 
  "not important" = c("(1) not importnat", "(2) somewhat unimportant"),
  "important"     = c("(3) somewhat important", "(4) very important")))
```

Confirm successful mutates for all indicators
```{r}
tbl1 %>% count(BS3B1,BS3B1_bin)
tbl1 %>% count(BS3B11,BS3B11_bin)
tbl1 %>% count(BS3B9,BS3B9_bin)
tbl1 %>% count(BS3B4,BS3B4_bin)
tbl1 %>% count(BS3B13,BS3B13_bin)
tbl1 %>% count(BS3B2,BS3B2_bin)
tbl1 %>% count(BS3B6,BS3B6_bin)
tbl1 %>% count(BS3B10,BS3B10_bin)
tbl1 %>% count(BS3B8,BS3B8_bin)
tbl1 %>% count(BS3B5,BS3B5_bin)
tbl1 %>% count(BS3B12,BS3B12_bin) 
tbl1 %>% count(BS3B3,BS3B3_bin)
```

Select for LCA vars tibble, including rename all 12 mutated variables and display first five lines of dataframe.  Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl1 <- tbl1 %>%
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         obey    = BS3B1_bin,
         rights  = BS3B11_bin,
         local   = BS3B9_bin,
         work    = BS3B4_bin,
         envir   = BS3B13_bin,
         vote    = BS3B2_bin,
         history = BS3B6_bin,
         respect = BS3B10_bin,
         news    = BS3B8_bin,
         protest = BS3B5_bin,
         discuss = BS3B12_bin,
         party   = BS3B3_bin)

tbl1 %>% head()
```


## 2009 dataloading and merging

2009 data: https://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/36997 
Downloaded Jan 17, 2019

Load 2009 country files, in chronological order of file names. Bind all 2009 files; Note, total observations of resulting tbl2 (140,650) concur with xls documentation of expected total n.

```{r}

tbl2 <- files %>%
  magrittr::extract(29:66) %>%      # filter to 2009 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A,
               IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B)) %>% 
  reduce(rbind) %>% 
  as_tibble() %>% 
  mutate(`ICCS_year` = 2009) %>%     # survey year variable creation
  select(`ICCS_year`, everything())
```

Recode all cit norm indicators. 

```{r}

tbl2 <- tbl2 %>% 
  mutate_at(vars(IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A, IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B),
            funs(bin = fct_collapse(.,
                                    "not important" = c("(3) NOT VERY IMPORTANT", "(4) NOT IMPORTANT AT ALL"),
                                    "important"     = c("(1) VERY IMPORTANT", "(2) QUITE IMPORTANT")))
  )
```

Confirm successful recodes.

```{r}

tbl2 %>% count(IS2P21L,IS2P21L_bin)
tbl2 %>% count(IS2P21I,IS2P21I_bin)
tbl2 %>% count(IS2P21H,IS2P21H_bin)
tbl2 %>% count(IS2P21K,IS2P21K_bin)
tbl2 %>% count(IS2P21J,IS2P21J_bin)
tbl2 %>% count(IS2P21A,IS2P21A_bin)
tbl2 %>% count(IS2P21C,IS2P21C_bin)
tbl2 %>% count(IS2P21E,IS2P21E_bin)
tbl2 %>% count(IS2P21D,IS2P21D_bin)
tbl2 %>% count(IS2P21G,IS2P21G_bin)
tbl2 %>% count(IS2P21F,IS2P21F_bin)
tbl2 %>% count(IS2P21B,IS2P21B_bin)
```

Select to rename all 12 mutated variables and display first five lines of dataframe - listed in order of 1999 descending means (IJCS article).  Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl2 <- tbl2 %>%
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         obey    = IS2P21L_bin,
         rights  = IS2P21I_bin,
         local   = IS2P21H_bin,
         work    = IS2P21K_bin,
         envir   = IS2P21J_bin,
         vote    = IS2P21A_bin,
         history = IS2P21C_bin,
         respect = IS2P21E_bin,
         news    = IS2P21D_bin,
         protest = IS2P21G_bin,
         discuss = IS2P21F_bin,
         party   = IS2P21B_bin) 

tbl2 %>% head()
```


## 2016 data loading and merging

2016 data: https://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/37147 
Downloaded Jan 21, 2019

2016 country files, in chronological order of file names. Bind all 2016 country files. Note, total observations of resulting tbl (94,603) concur with xls documentation of expected total n.

```{r}

tbl3 <- files %>%
  magrittr::extract(67:90) %>%      # filter to 2016 files only
  map(~ .x %>%
        load_files() %>%
        select(COUNTRY, IDCNTRY, IDSTUD, IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J,
               IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B)) %>% 
  reduce(rbind) %>% 
  as_tibble()%>% 
  mutate(`ICCS_year` = 2016) %>%    # create survey year variable
  select(`ICCS_year`, everything())
```


Recode all cit norm indicators by expanding prior successful code of 1st indicator. 

```{r}

tbl3 <- tbl3 %>% 
  mutate_at(vars(IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J, IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B),
            funs(bin = fct_collapse(.,
                                    "not important" = c("(3) Not very important", "(4) Not important at all"),
                                    "important"     = c("(1) Very important", "(2) Quite important")))
  )
```

Confirm successful mutates.

```{r}

tbl3 %>% count(IS3G23L,IS3G23L_bin)
tbl3 %>% count(IS3G23I,IS3G23I_bin)
tbl3 %>% count(IS3G23H,IS3G23H_bin)
tbl3 %>% count(IS3G23K,IS3G23K_bin)
tbl3 %>% count(IS3G23J,IS3G23J_bin)
tbl3 %>% count(IS3G23A,IS3G23A_bin)
tbl3 %>% count(IS3G23C,IS3G23C_bin)
tbl3 %>% count(IS3G23E,IS3G23E_bin)
tbl3 %>% count(IS3G23D,IS3G23D_bin)
tbl3 %>% count(IS3G23G,IS3G23G_bin)
tbl3 %>% count(IS3G23F,IS3G23F_bin)
tbl3 %>% count(IS3G23B,IS3G23B_bin)
```

Select to rename all 12 mutated variables and display first five lines of dataframe - listed in order of 1999 descending means (IJCS article). Use "select" for key LCA variables to create reduced tbl that can be "binded" with other ICCS years.

```{r}

tbl3 <- tbl3 %>% 
  select(ICCS_year,
         COUNTRY,
         IDSTUD,
         obey    = IS3G23L_bin,
         rights  = IS3G23I_bin,
         local   = IS3G23H_bin,
         work    = IS3G23K_bin,
         envir   = IS3G23J_bin,
         vote    = IS3G23A_bin,
         history = IS3G23C_bin,
         respect = IS3G23E_bin,
         news    = IS3G23D_bin,
         protest = IS3G23G_bin,
         discuss = IS3G23F_bin,
         party   = IS3G23B_bin)

tbl3 %>% head()
```


## Combining recoded 1999, 2009 and 2016 data frames 

Combine the three data frames and create unique id per observation across binded country files to be able to import Latent Gold class assignment for each unique observation.

```{r}

tbl <- rbind(tbl1, tbl2, tbl3) %>% 
  mutate(id = row_number(),
         id2 = paste0(COUNTRY, IDSTUD))
```

A couple example summary tables:

```{r}

# count observations by survey year
tbl %>% 
  count(ICCS_year) %>% 
  knitr::kable()

# count and percent of responses to "obey" grouped by year
tbl %>%
  group_by(ICCS_year) %>% 
  count(obey) %>% 
  mutate(percent = (n / sum(n)) * 100) %>% 
  knitr::kable()
```

Export recoded data for LCA - RdM to current `ICCS-2019/clean-data` directory.

```{r}

write.table(tbl, "clean_tbl.dat", row.names=FALSE, quote = FALSE)
```
