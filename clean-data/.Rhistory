select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3, gender, bsgbook, expeduc, bsgedum, bsgeduf, TOTWGT)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 1999) %>%     # add survey year variable
select(`ICCS_year`, everything())
# all files
files <- list.files("../data", full.names = TRUE)
# helper function to load files
load_files <- function(file) {
e <- new.env()
load(file, envir = e)
stopifnot(length(e) == 1)  # safety first
get(names(e)[1], envir = e)
}
tbl1 <- files %>%
magrittr::extract(1:28) %>%      # filter to 1999 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3, GENDER, bsgbook, expeduc, bsgedum, bsgeduf, TOTWGT)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 1999) %>%     # add survey year variable
select(`ICCS_year`, everything())
# all files
files <- list.files("../data", full.names = TRUE)
# helper function to load files
load_files <- function(file) {
e <- new.env()
load(file, envir = e)
stopifnot(length(e) == 1)  # safety first
get(names(e)[1], envir = e)
}
tbl1 <- files %>%
magrittr::extract(1:28) %>%      # filter to 1999 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3, GENDER,BSGBOOK, EXPEDUC, BSGEDUM, BSGEDUF, TOTWGT)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 1999) %>%     # add survey year variable
select(`ICCS_year`, everything())
tbl1 %>%
count(BSGBOOK)
# recode
tbl1 <- tbl1 %>%
mutate(BSGBOOK_bin = fct_collapse(BSGBOOK,
"0 to 50" = c("(1) None", "(2) 1 - 10", "(3) 11 - 50"),
"51-200" = c("(4) 51 - 100", "(5) 101 - 200"),
"201+" = "(6) More than 200)"))
# confirm correct recode
tbl1 %>%
count(BSGBOOK_bin, BSGBOOK)
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE, fig.width = 10)
library(tidyverse)
library(readr)
library(purrr)
library(writexl)
# Chunk 2
# all files
files <- list.files("../data", full.names = TRUE)
# helper function to load files
load_files <- function(file) {
e <- new.env()
load(file, envir = e)
stopifnot(length(e) == 1)  # safety first
get(names(e)[1], envir = e)
}
tbl1 <- files %>%
magrittr::extract(1:28) %>%      # filter to 1999 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3, GENDER,BSGBOOK, EXPEDUC, BSGEDUM, BSGEDUF, TOTWGT)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 1999) %>%     # add survey year variable
select(`ICCS_year`, everything())
# Chunk 3
tbl1 %>%
count(BSGBOOK)
# Chunk 4
# recode
tbl1 <- tbl1 %>%
mutate(BSGBOOK_bin = fct_collapse(BSGBOOK,
"0 to 50" = c("(1) None", "(2) 1 - 10", "(3) 11 - 50"),
"51-200" = c("(4) 51 - 100", "(5) 101 - 200"),
"201+" = "(6) More than 200)"))
# confirm correct recode
tbl1 %>%
count(BSGBOOK_bin, BSGBOOK)
# Chunk 5
original_vars <- tbl1 %>%
select(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3) %>%
colnames()
original_vars %>%
map(~ tbl1 %>% count(!!sym(.x)))
# Chunk 6
# recode
tbl1 <- tbl1 %>%
mutate(BS3B1_binary = fct_collapse(BS3B1,
"not important" = c("(1) not important", "(2) somewhat unimportant"),
"important"     = c("(3) somewhat important", "(4) very important")))
# confirm correct recode
tbl1 %>%
count(BS3B1, BS3B1_binary)
# Chunk 7
tbl1 <-tbl1 %>%
mutate_at(vars(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B3),
funs(bin = fct_collapse(.,
"not important"= c("(1) not important", "(2) somewhat unimportant"),
"important"    = c("(3) somewhat important", "(4) very important")))
)
# Chunk 8
# troubleshoot
tbl1 %>% count(BS3B12)
# recode
tbl1 <- tbl1 %>%
mutate(BS3B12_bin = fct_collapse(BS3B12,
"not important" = c("(1) not importnat", "(2) somewhat unimportant"),
"important"     = c("(3) somewhat important", "(4) very important"))
)
# Chunk 9
bin_vars <- original_vars %>%
paste0("_bin")
map2(original_vars, bin_vars, ~ tbl1 %>% count(!!sym(.x), !!sym(.y)))
tbl1 <- tbl1 %>%
select(ICCS_year,
COUNTRY,
IDSTUD,
TOTWGTS = TOTWGT,
obey    = BS3B1_bin,
rights  = BS3B11_bin,
local   = BS3B9_bin,
work    = BS3B4_bin,
envir   = BS3B13_bin,
vote    = BS3B2_bin,
history = BS3B6_bin,
respect = BS3B10_bin,
news    = BS3B8_bin,
protest = BS3B5_bin,
discuss = BS3B12_bin,
party   = BS3B3_bin,
books   = BSGBOOK_bin)
tbl1 %>% head()
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE, fig.width = 10)
library(tidyverse)
library(readr)
library(purrr)
library(writexl)
# Chunk 2
# all files
files <- list.files("../data", full.names = TRUE)
# helper function to load files
load_files <- function(file) {
e <- new.env()
load(file, envir = e)
stopifnot(length(e) == 1)  # safety first
get(names(e)[1], envir = e)
}
tbl1 <- files %>%
magrittr::extract(1:28) %>%      # filter to 1999 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, BS3B1, BS3B11, BS3B9, BS3B4, BS3B13,
BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3, GENDER,BSGBOOK, EXPEDUC, BSGEDUM, BSGEDUF, TOTWGT)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 1999) %>%     # add survey year variable
select(`ICCS_year`, everything())
# Chunk 3
tbl1 %>%
count(BSGBOOK)
# Chunk 4
# recode
tbl1 <- tbl1 %>%
mutate(BSGBOOK_bin = fct_collapse(BSGBOOK,
"0 to 50" = c("(1) None", "(2) 1 - 10", "(3) 11 - 50"),
"51-200" = c("(4) 51 - 100", "(5) 101 - 200"),
"201+" = "(6) More than 200)"))
# confirm correct recode
tbl1 %>%
count(BSGBOOK_bin, BSGBOOK)
# Chunk 5
original_vars <- tbl1 %>%
select(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B12, BS3B3) %>%
colnames()
original_vars %>%
map(~ tbl1 %>% count(!!sym(.x)))
# Chunk 6
# recode
tbl1 <- tbl1 %>%
mutate(BS3B1_binary = fct_collapse(BS3B1,
"not important" = c("(1) not important", "(2) somewhat unimportant"),
"important"     = c("(3) somewhat important", "(4) very important")))
# confirm correct recode
tbl1 %>%
count(BS3B1, BS3B1_binary)
# Chunk 7
tbl1 <-tbl1 %>%
mutate_at(vars(BS3B1, BS3B11, BS3B9, BS3B4, BS3B13, BS3B2, BS3B6, BS3B10, BS3B8, BS3B5, BS3B3),
funs(bin = fct_collapse(.,
"not important"= c("(1) not important", "(2) somewhat unimportant"),
"important"    = c("(3) somewhat important", "(4) very important")))
)
# Chunk 8
# troubleshoot
tbl1 %>% count(BS3B12)
# recode
tbl1 <- tbl1 %>%
mutate(BS3B12_bin = fct_collapse(BS3B12,
"not important" = c("(1) not importnat", "(2) somewhat unimportant"),
"important"     = c("(3) somewhat important", "(4) very important"))
)
# Chunk 9
bin_vars <- original_vars %>%
paste0("_bin")
map2(original_vars, bin_vars, ~ tbl1 %>% count(!!sym(.x), !!sym(.y)))
# Chunk 10
tbl1 <- tbl1 %>%
select(ICCS_year,
COUNTRY,
IDSTUD,
TOTWGTS = TOTWGT,
obey    = BS3B1_bin,
rights  = BS3B11_bin,
local   = BS3B9_bin,
work    = BS3B4_bin,
envir   = BS3B13_bin,
vote    = BS3B2_bin,
history = BS3B6_bin,
respect = BS3B10_bin,
news    = BS3B8_bin,
protest = BS3B5_bin,
discuss = BS3B12_bin,
party   = BS3B3_bin)
tbl1 %>% head()
# Chunk 11
tbl2 <- files %>%
magrittr::extract(29:66) %>%      # filter to 2009 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A,
IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B, TOTWGTS)) %>%
reduce(rbind) %>%
as_tibble() %>%
mutate(`ICCS_year` = 2009) %>%     # survey year variable creation
select(`ICCS_year`, everything())
# Chunk 12
original_vars <- tbl2 %>%
select(IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A, IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B) %>%
colnames()
original_vars %>%
map(~ tbl2 %>% count(!!sym(.x)))
# Chunk 13
tbl2 <- tbl2 %>%
mutate_at(vars(IS2P21L, IS2P21I, IS2P21H, IS2P21K, IS2P21J, IS2P21A, IS2P21C, IS2P21E, IS2P21D, IS2P21G, IS2P21F, IS2P21B),
funs(bin = fct_collapse(.,
"not important" = c("(3) NOT VERY IMPORTANT", "(4) NOT IMPORTANT AT ALL"),
"important"     = c("(1) VERY IMPORTANT", "(2) QUITE IMPORTANT")))
)
# Chunk 14
bin_vars <- original_vars %>%
paste0("_bin")
map2(original_vars, bin_vars, ~ tbl2 %>% count(!!sym(.x), !!sym(.y)))
# Chunk 15
tbl2 <- tbl2 %>%
select(ICCS_year,
COUNTRY,
IDSTUD,
TOTWGTS,
obey    = IS2P21L_bin,
rights  = IS2P21I_bin,
local   = IS2P21H_bin,
work    = IS2P21K_bin,
envir   = IS2P21J_bin,
vote    = IS2P21A_bin,
history = IS2P21C_bin,
respect = IS2P21E_bin,
news    = IS2P21D_bin,
protest = IS2P21G_bin,
discuss = IS2P21F_bin,
party   = IS2P21B_bin)
tbl2 %>% head()
# Chunk 16
tbl3 <- files %>%
magrittr::extract(67:90) %>%      # filter to 2016 files only
map(~ .x %>%
load_files() %>%
select(COUNTRY, IDCNTRY, IDSTUD, IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J,
IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B, TOTWGTS)) %>%
reduce(rbind) %>%
as_tibble()%>%
mutate(`ICCS_year` = 2016) %>%    # create survey year variable
select(`ICCS_year`, everything())
# Chunk 17
original_vars <- tbl3 %>%
select(IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J, IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B) %>%
colnames()
original_vars %>%
map(~ tbl3 %>% count(!!sym(.x)))
# Chunk 18
tbl3 <- tbl3 %>%
mutate_at(vars(IS3G23L, IS3G23I, IS3G23H, IS3G23K, IS3G23J, IS3G23A, IS3G23C, IS3G23E, IS3G23D, IS3G23G, IS3G23F, IS3G23B),
funs(bin = fct_collapse(.,
"not important" = c("(3) Not very important", "(4) Not important at all"),
"important"     = c("(1) Very important", "(2) Quite important")))
)
# Chunk 19
bin_vars <- original_vars %>%
paste0("_bin")
map2(original_vars, bin_vars, ~ tbl3 %>% count(!!sym(.x), !!sym(.y)))
# Chunk 20
tbl3 <- tbl3 %>%
select(ICCS_year,
COUNTRY,
IDSTUD,
TOTWGTS,
obey    = IS3G23L_bin,
rights  = IS3G23I_bin,
local   = IS3G23H_bin,
work    = IS3G23K_bin,
envir   = IS3G23J_bin,
vote    = IS3G23A_bin,
history = IS3G23C_bin,
respect = IS3G23E_bin,
news    = IS3G23D_bin,
protest = IS3G23G_bin,
discuss = IS3G23F_bin,
party   = IS3G23B_bin)
tbl3 %>% head()
# Chunk 21
tbl <- rbind(tbl1, tbl2, tbl3) %>%
mutate(id  = row_number(),
id2 = paste0(COUNTRY, IDSTUD))
# Chunk 22
# number of observations by survey year
tbl %>%
count(ICCS_year) %>%
knitr::kable()
# Chunk 23
cit_norm_indicators <- vars(obey, rights, local, work, envir, vote, history, respect, news, protest, discuss, party)
tbl <- tbl %>%
mutate_at(cit_norm_indicators,
funs(as.integer(case_when(
. == "not important" ~ 0,
. == "important"     ~ 1
)))
) %>%
mutate_at(vars(ICCS_year, IDSTUD), as.integer) %>%
mutate(COUNTRY = as.character(COUNTRY))
tbl %>% head()
# Chunk 24
example <- tbl %>%
mutate_at(cit_norm_indicators,
funs(haven::labelled(., labels = c("not important" = 0, "important" = 1))))
# cit norm indicator vars are now int+lbl type
example %>%
glimpse()
# access labels by converting those vars to factors
example %>%
mutate_at(cit_norm_indicators, funs(as_factor(.)))
# Chunk 25
write_delim(tbl, "output/clean_tbl.dat", na = ".")
# Chunk 26
# count and percent of responses to "obey" grouped by year
means <- tbl %>%
group_by(COUNTRY, ICCS_year) %>%
summarize_at(cit_norm_indicators, funs(round(mean(., na.rm = TRUE), 3)))
means %>%
knitr::kable()
# Chunk 27
missing <- tbl %>%
group_by(COUNTRY, ICCS_year) %>%
summarize_at(cit_norm_indicators,
funs(paste0(sum(is.na(.)), " (", (round(sum(is.na(.)) / length(.) * 100, 2)), "%)")))
missing %>%
knitr::kable()
# Chunk 28
write_xlsx(list(means = means, missing = missing), "output/citizenship-norm-indicator-tables.xlsx")
# Chunk 29
all_wave_countries <- tbl %>%
count(COUNTRY, ICCS_year) %>%
count(COUNTRY) %>%
filter(nn == 3) %>%
pull(COUNTRY)
# table with lower and upper limits for error bars
plot_tbl <- tbl %>%
filter(COUNTRY %in% all_wave_countries) %>%
group_by(ICCS_year) %>%
summarize_at(cit_norm_indicators, funs(t.test(.) %>%
broom::tidy() %>%
mutate(mean_ci = paste(estimate, conf.low, conf.high)) %>%
pull(mean_ci))) %>%
gather(Indicator, value, -ICCS_year) %>%
mutate(value = str_split(value, " "),
cols = map(value, ~ data.frame(t(.)))) %>%
unnest(cols) %>%
select(-value) %>%
mutate(mean  = as.numeric(X1),
lower = as.numeric(X2),
upper = as.numeric(X3)) %>%
select(-c(X1, X2, X3))
plot_tbl %>%
mutate_if(is.numeric, round, 3) %>%
knitr::kable()
# Chunk 30: line-plots-all
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .3) +
geom_line() +
geom_point() +
lims(y = c(0, 1)) +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year")
ggsave("output/mean-citizenship-norm-line-plot-by-year.png")
# Chunk 31: line-plots-facet
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "free") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none")
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none")
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none")
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none") +
scale_x_continuous(breaks=c(1999, 2009, 2016))
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none", axis.text.x = element_text(size=1)) +
scale_x_continuous(breaks=c(1999, 2009, 2016))
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none", axis.text.x = element_text(size=9)) +
scale_x_continuous(breaks=c(1999, 2009, 2016))
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none", axis.text.x = element_text(size=5)) +
scale_x_continuous(breaks=c(1999, 2009, 2016))
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
# line plot with year on x-axis, lines colored by indicator type
plot_tbl %>%
mutate(Indicator=fct_relevel(Indicator,c("obey", "rights", "local", "work", "envir", "vote", "history", "respect", "news", "protest", "discuss", "party"))) %>%
ggplot(aes(x = ICCS_year, y = mean, group = Indicator, colour = Indicator)) +
geom_errorbar(aes(ymin = lower, ymax = upper), width = .5) +
geom_line() +
geom_point() +
facet_wrap(~Indicator, scales = "fixed") +
labs(x = "Year", y = "Mean", title = "Mean Citizenship Norm Indicators By Survey Year") +
theme(legend.position = "none", axis.text.x = element_text(size=7)) +
scale_x_continuous(breaks=c(1999, 2009, 2016))
ggsave("output/mean-citizenship-norm-line-plot-by-year-facet.png")
